#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <signal.h>
#include <unistd.h>

int n = 0;

struct action {
   char activity[8];
   char room[5];
   char www;
};

struct rooms {
   char names[8][40];
   int roomCount;
} rooms;

void flush(void) {
    int ch;
    while ((ch = getchar()) && ch != EOF && ch != '\n'){}
}

void show_rooms() {
   printf("List of rooms: \n\n");
   for (int i = 0; i < rooms.roomCount; i++) {
      printf("[%d] %s\n", i, rooms.names[i]);
   }
   puts("");
}

void menu_loop() {
    struct action log[8] = {};
    rooms.roomCount = 0;

    for (int i = 0; i < 8; i++) {

        puts("");
        puts("[A]ction");
        puts("[S]how activity log");
        puts("[Q]uit");
        puts("");
        puts("Enter your choice, (or press enter to refresh): ");

        char ch = getchar();

        switch (ch) {
            case EOF:
            case 'q':
            case 'Q':
                return;

            case 'A':
            case 'a':
                flush();

                for (int j = 0;; j++) {

                    puts("");
                    puts("[A]dd room");
                    puts("[S]elect room");
                    puts("[L]ist rooms");
                    puts("");
                    puts("Enter your choice, (or press enter to refresh): ");

                    char c = getchar();

                    switch (c) {
                       case 'A':
                       case 'a':
                          flush();
                          char buffer[40];
                          puts("Enter room name (max 5 chars): ");
                          scanf("%39s", buffer);
                          for (int k = 0; k < rooms.roomCount; k++) {
                             if (!strcmp(buffer, rooms.names[k])) {
                                printf(buffer);
                                puts(" already exists!");
                                goto somewhere;
                             }
                          }
                          if (rooms.roomCount == 8) {
                             puts("Your free trial has expired.");
                             exit(0);
                          }
                          strcpy(rooms.names[rooms.roomCount++], buffer);
                          flush();
                          break;
                       case 'S':
                       case 's':
                          flush();
                          show_rooms();
                          printf("Enter room number: ");
                          int input;
                          scanf("%d", &input);
                          flush();
                          if (input < 0 || input >= rooms.roomCount) {
                             puts("Index out of range");
                             break;
                          }
                          strcpy(log[n].room, rooms.names[input]);
                          printf("Enter activity (max 7 chars): ");
                          fgets(log[n].activity, 8, stdin); //read in 7 bytes, append null byte
                          flush();
                          log[n].www = 0;
                          ++n;
                          goto somewhere;
                       case 'L':
                       case 'l':
                          flush();
                          show_rooms();
                          break;
                       default:
                          flush();
                          printf("\n");
                          break;
                    }
                               
                }


                break;

            case 'S':
            case 's':
                flush();
                puts("still too lazy to implement this sorry lol");
                break;

            default:
                flush();
                puts("");
                break;
        }
somewhere:;
    }
    puts("Your free trial has expired.");
    return;
}

 void lol (int s) {(void) s; puts("Your free trial has expired."); exit(0);}
int main(void) {
    setbuf(stdout, NULL);
    alarm(12);
    //signal(SIGALRM, ({void lol (int s) {(void) s; puts("Your free trial has expired."); exit(0);} lol;}));
    signal(SIGALRM, lol);

    char name[40];
    printf("What's your name?\nName: ");
    fgets(name, 42, stdin);
    printf("\nHi %s! Welcome to the isolation minigame (v2.0-beta1).\n"
          "You are currently playing a free trial of the game.\n", name);
    puts("-------------------------------------------------------");
    puts("You are stuck in your house. What will you do next?");

    menu_loop();
}
